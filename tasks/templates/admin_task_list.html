{% extends "base.html" %}
{% block content %}
<div class="container">
  <h2 class="text-primary mb-4">Admin Task Permissions</h2>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}

  <!-- User Selection -->
  <form method="get" class="mb-4">
    <div class="row g-3 align-items-center">
      <div class="col-auto">
        <label for="user_id" class="col-form-label">Select User:</label>
      </div>
      <div class="col-auto">
        <select name="user_id" id="user_id" class="form-select" onchange="this.form.submit()">
          <option value="">-- Select a User --</option>
          {% for user in all_users %}
            <option value="{{ user.id }}" {% if selected_user.id == user.id %}selected{% endif %}>
              {{ user.username }}
            </option>
          {% endfor %}
        </select>
      </div>
    </div>
  </form>

  {% if selected_user %}
    <!-- Project Selection -->
    <form method="get" class="mb-4">
      <input type="hidden" name="user_id" value="{{ selected_user.id }}">
      <div class="row g-3 align-items-center">
        <div class="col-auto">
          <label for="project_id" class="col-form-label">Select Project for {{ selected_user.username }}:</label>
        </div>
        <div class="col-auto">
          <select name="project_id" id="project_id" class="form-select" onchange="this.form.submit()">
            <option value="">-- Select a Project --</option>
            {% for project in projects %}
              <option value="{{ project.id }}" {% if selected_project.id == project.id %}selected{% endif %}>
                {{ project.name }}
              </option>
            {% endfor %}
          </select>
        </div>
      </div>
    </form>

    {% if selected_project %}
      <!-- Tasks and Permissions -->
      <h4>Tasks in {{ selected_project.name }}</h4>
      {% if tasks %}
        <table class="table table-hover">
          <thead class="table-light">
            <tr>
              <th>Title</th>
              <th>Owner</th>
              <th>Current Permission</th>
              <th>Change Permission</th>
            </tr>
          </thead>
          <tbody>
            {% for task in tasks %}
              <tr>
                <td>{{ task.title }}</td>
                <td>{{ task.user.username }}</td>
                <td>
                  {% if task.user_permission == 'owner' %}
                    Owner (Full Permissions)
                  {% elif task.user_permission %}
                    {{ task.user_permission|title }}
                  {% else %}
                    No Permission
                  {% endif %}
                </td>
                <td>
                  {% if task.user_permission == 'owner' %}
                    <span class="text-muted">Cannot modify owner's permissions</span>
                  {% else %}
                    <form method="post" action="{% url 'set_task_permission' task.id %}">
                      {% csrf_token %}
                      <input type="hidden" name="user_id" value="{{ selected_user.id }}">
                      <select name="permission_type" class="form-select d-inline w-auto">
                        <option value="" {% if not task.user_permission %}selected{% endif %}>No Permission</option>
                        <option value="view" {% if task.user_permission == 'view' %}selected{% endif %}>View</option>
                        <option value="edit" {% if task.user_permission == 'edit' %}selected{% endif %}>Edit</option>
                        <option value="delete" {% if task.user_permission == 'delete' %}selected{% endif %}>Delete</option>
                      </select>
                      <button type="submit" class="btn btn-sm btn-primary ms-2">Update</button>
                    </form>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div class="alert alert-info">
          No tasks found in this project.
        </div>
      {% endif %}
    {% endif %}
  {% endif %}
</div>
{% endblock %}